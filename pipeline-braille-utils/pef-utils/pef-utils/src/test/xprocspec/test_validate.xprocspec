<?xml version="1.0" encoding="UTF-8"?>
<x:description xmlns:x="http://www.daisy.org/ns/xprocspec"
               xmlns:p="http://www.w3.org/ns/xproc"
               xmlns:pef="http://www.daisy.org/ns/2008/pef"
               xmlns:d="http://www.daisy.org/ns/pipeline/data"
               xmlns:c="http://www.w3.org/ns/xproc-step"
               xmlns:svrl="http://purl.oclc.org/dsdl/svrl"
               script="../../main/resources/xml/validate.xpl">

  <x:script>
    <p:declare-step type="pef:test-validate" name="main" version="1.0">
      <p:import href="../../main/resources/xml/validate.xpl"/>
      <p:input port="source"/>
      <p:output port="result" primary="true" sequence="true"/>
      <p:output port="report" sequence="true">
        <p:pipe step="validate" port="report"/>
      </p:output>
      <p:output port="html-report" sequence="true">
        <p:pipe step="normalize-html" port="result"/>
      </p:output>
      
      <p:option name="assert-valid"/>
      
      <pef:validate name="validate">
        <p:with-option name="assert-valid" select="$assert-valid"/>
      </pef:validate>

      <p:sink/>

      <p:delete name="normalize-html" match="*[@id='datetime']|@id|//*[local-name()='code']">
        <p:input port="source" sequence="true">
	  <p:pipe step="validate" port="html-report"/>
	</p:input>
      </p:delete>

    </p:declare-step>
  </x:script>

  <!-- Test valid file -->
  <x:scenario label="test_01">
    <x:call step="pef:test-validate">
      <x:input port="source">
        <x:document type="file" href="../resources/pef_valid.pef"/>
      </x:input>
      <x:option name="assert-valid" select="'true'"/>
    </x:call>
    <x:context label="errors">
      <x:document type="errors"/>
    </x:context>
    <x:expect label="number-of-errors" type="count" max="0"/>
  </x:scenario>

  <!-- Test invalid file against schematron -->
  <x:scenario label="test_02">
    <x:call step="pef:test-validate">
      <x:input port="source">
        <x:document type="file" href="../resources/pef_invalid_schematron.pef"/>
      </x:input>
      <x:option name="assert-valid" select="'true'"/>
    </x:call>
    <x:context label="errors">
      <x:document type="errors"/>
    </x:context>
    <x:expect label="number-of-errors" type="count" min="1"/>
  </x:scenario>

  <!-- Test invalid file against Relax NG -->
  <x:scenario label="test_03">
    <x:call step="pef:test-validate">
      <x:input port="source">
        <x:document type="file" href="../resources/pef_invalid_relax_ng.pef"/>
      </x:input>
      <x:option name="assert-valid" select="'true'"/>
    </x:call>
    <x:context label="errors">
      <x:document type="errors"/>
    </x:context>
    <x:expect label="number-of-errors" type="count" min="1"/>
  </x:scenario>

  <!-- Test error report from schematron -->
  <x:scenario label="test_04">
    <x:call step="pef:test-validate">
      <x:input port="source">
        <x:document type="file" href="../resources/pef_invalid_schematron.pef"/>
      </x:input>
      <x:option name="assert-valid" select="'false'"/>
    </x:call>
    <x:context label="report">
      <x:document type="port" port="report"/>
    </x:context>
    <x:expect label="error" type="xpath"
              test="string(//d:reports/d:report//svrl:failed-assert/svrl:text)"
              equals="'[Rule 1] Rows do not fit within the defined page height'"/>
  </x:scenario>

  <!-- Test error report from Relax NG -->
  <x:scenario label="test_05">
    <x:call step="pef:test-validate">
      <x:input port="source">
        <x:document type="file" href="../resources/pef_invalid_relax_ng.pef"/>
      </x:input>
      <x:option name="assert-valid" select="'false'"/>
    </x:call>
    <x:context label="report">
      <x:document type="port" port="report"/>
    </x:context>
    <x:expect label="error" type="xpath"
              test="contains(string(/d:reports/d:report//c:error), 'character content of element &quot;dc:date&quot; invalid')"/>
  </x:scenario>

  <!-- Test HTML report from valid file -->
  <x:scenario label="test_06">
    <x:call step="pef:test-validate">
      <x:input port="source">
        <x:document type="file" href="../resources/pef_valid.pef"/>
      </x:input>
      <x:option name="assert-valid" select="'false'"/>
    </x:call>
    <x:context label="html-report">
      <x:document type="port" port="html-report"/>
    </x:context>
    <x:expect label="html-report" type="compare">
      <x:document type="inline">
      <html xmlns="http://www.w3.org/1999/xhtml">
        <head>
          <title>Validation Results</title>
          <style type="text/css"> body { font-family: helvetica; } pre.box { white-space: pre-wrap; /* css-3 */ white-space: -moz-pre-wrap; /*Mozilla, since 1999 */ white-space: -pre-wrap; /* Opera 4-6 */ white-space: -o-pre-wrap; /* Opera 7 */ word-wrap: break-word; /*Internet Explorer 5.5+ */ } li.error div { display: table; border: gray thin solid; padding: 5px; } li.error div h3 { display: table-cell; padding-right: 10px; font-size: smaller; } li.error div pre.box { display: table-cell; } li { padding-bottom: 15px; } #toc { border-spacing: 0px; } #toc th, #toc td { padding: 5px 30px 5px 10px; border-spacing: 0px; font-size: 90%; margin: 0px; } #toc th, #toc td { text-align: left; border-top: 1px solid #f1f8fe; border-bottom: 1px solid #cbd2d8; border-right: 1px solid #cbd2d8; } #toc tr:nth-child(odd) { background-color: #e0e9f0; } #toc tr:nth-child(even), #toc thead th { background-color: #e8eff5; !important; } </style>
        </head>
        <body>
          <div>
            <h1>Validation Results</h1>
          </div>
          <div class="document-validation-report">
            <div class="document-info">
              <h2>
              </h2>
              <p>Validated as
              </p>
              <p>Path:
              </p>
              <p>0 issues found.</p>
            </div>
            <div class="document-report">
              <ul/>
            </div>
          </div>
          <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"> </script>
        </body>
      </html>
      </x:document>
    </x:expect>
  </x:scenario>

  <!-- Test HTML report from file that's invalid against Schematron -->
  <x:scenario label="test_07">
    <x:call step="pef:test-validate">
      <x:input port="source">
        <x:document type="file" href="../resources/pef_invalid_schematron.pef"/>
      </x:input>
      <x:option name="assert-valid" select="'false'"/>
    </x:call>
    <x:context label="html-report">
      <x:document type="port" port="html-report"/>
    </x:context>
    <x:expect label="html-report" type="compare">
      <x:document type="inline">
      <html xmlns="http://www.w3.org/1999/xhtml">
        <head>
          <title>Validation Results</title>
          <style type="text/css"> body { font-family: helvetica; } pre.box { white-space: pre-wrap; /* css-3 */ white-space: -moz-pre-wrap; /*Mozilla, since 1999 */ white-space: -pre-wrap; /* Opera 4-6 */ white-space: -o-pre-wrap; /* Opera 7 */ word-wrap: break-word; /*Internet Explorer 5.5+ */ } li.error div { display: table; border: gray thin solid; padding: 5px; } li.error div h3 { display: table-cell; padding-right: 10px; font-size: smaller; } li.error div pre.box { display: table-cell; } li { padding-bottom: 15px; } #toc { border-spacing: 0px; } #toc th, #toc td { padding: 5px 30px 5px 10px; border-spacing: 0px; font-size: 90%; margin: 0px; } #toc th, #toc td { text-align: left; border-top: 1px solid #f1f8fe; border-bottom: 1px solid #cbd2d8; border-right: 1px solid #cbd2d8; } #toc tr:nth-child(odd) { background-color: #e0e9f0; } #toc tr:nth-child(even), #toc thead th { background-color: #e8eff5; !important; } </style>
        </head>
        <body>
          <div>
            <h1>Validation Results</h1>
          </div>
          <div class="document-validation-report">
            <div class="document-info">
              <h2>
              </h2>
              <p>Validated as
              </p>
              <p>Path:
              </p>
              <p>1 issue found.</p>
            </div>
            <div class="document-report">
              <ul>
                <li class="error">
                  <p>[Rule 1] Rows do not fit within the defined page height</p>
                  <div>
                    <h3>Location (XPath)</h3>
                    <pre>/*[local-name()='pef']/*[local-name()='body']/*[local-name()='volume']/*[local-name()='section']/*[local-name()='page']</pre>
                  </div>
                </li>
              </ul>
            </div>
          </div>
          <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"> </script>
        </body>
      </html>
      </x:document>
    </x:expect>
  </x:scenario>

  <!-- Test HTML report from file that's invalid against Relax NG -->
  <x:scenario label="test_08">
    <x:call step="pef:test-validate">
      <x:input port="source">
        <x:document type="file" href="../resources/pef_invalid_relax_ng.pef"/>
      </x:input>
      <x:option name="assert-valid" select="'false'"/>
    </x:call>
    <x:context label="html-report">
      <x:document type="port" port="html-report"/>
    </x:context>
    <x:expect label="html-report" type="compare">
      <x:document type="inline">
      <html xmlns="http://www.w3.org/1999/xhtml">
        <head>
          <title>Validation Results</title>
          <style type="text/css"> body { font-family: helvetica; } pre.box { white-space: pre-wrap; /* css-3 */ white-space: -moz-pre-wrap; /*Mozilla, since 1999 */ white-space: -pre-wrap; /* Opera 4-6 */ white-space: -o-pre-wrap; /* Opera 7 */ word-wrap: break-word; /*Internet Explorer 5.5+ */ } li.error div { display: table; border: gray thin solid; padding: 5px; } li.error div h3 { display: table-cell; padding-right: 10px; font-size: smaller; } li.error div pre.box { display: table-cell; } li { padding-bottom: 15px; } #toc { border-spacing: 0px; } #toc th, #toc td { padding: 5px 30px 5px 10px; border-spacing: 0px; font-size: 90%; margin: 0px; } #toc th, #toc td { text-align: left; border-top: 1px solid #f1f8fe; border-bottom: 1px solid #cbd2d8; border-right: 1px solid #cbd2d8; } #toc tr:nth-child(odd) { background-color: #e0e9f0; } #toc tr:nth-child(even), #toc thead th { background-color: #e8eff5; !important; } </style>
        </head>
        <body>
          <div>
            <h1>Validation Results</h1>
          </div>
          <div class="document-validation-report">
            <div class="document-info">
              <h2>
	      </h2>
              <p>Validated as
              </p>
              <p>Path:
              </p>
              <p>0 issues found.</p>
            </div>
            <div class="document-report">
              <ul>
                <li class="message-error">
                  <p>org.xml.sax.SAXParseException; systemId: file:/Users/jukka/workspace/duuni_celia/pipeline-mod-braille/pipeline-braille-utils/pef-utils/pef-utils/src/test/resources/pef_invalid_relax_ng.pef; lineNumber: 5; columnNumber: 42; character content of element "dc:date" invalid; must be a string matching the regular expression "[0-9]{4}-[0-9]{2}-[0-9]{2}"</p>
                  <div class="message-details"/>
                </li>
              </ul>
              <ul/>
            </div>
          </div>
          <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"> </script>
        </body>
      </html>
      </x:document>
    </x:expect>
  </x:scenario>


</x:description>
